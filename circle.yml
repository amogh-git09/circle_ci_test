machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  ruby:
    version: ruby-2.3.1
  post:
    - sudo service mysql stop
    - sudo service redis-server stop
    - mkdir -p ~/.my_cache

dependencies:
  pre:
    - if [ -d "~/.my_cache/ruby-2.3.1" ]; then sudo cp -r ~/.my_cache/ruby-2.3.1 ~/.rvm/gems/ruby-2.3.1; fi
    - sudo pip install docker-compose
  post:
    - docker-compose up -d
    # - (cd rails_module; bundle install;)
    - mkdir -p ~/.my_cache/ruby-2.3.1
    - sudo cp -r ~/.rvm/gems/ruby-2.3.1 ~/.my_cache/ruby-2.3.1
  cache_directories:
    - ~/.my_cache

test:
  override:
    - ./script.sh:
        parallel: true
    - ./deploy_script.sh:
        parallel: true

# deployment:
#   staging:
#     branch: master
#     commands:
#       - aws s3 sync deployment s3://tenma-dev-dap/circle_ci/ --delete
